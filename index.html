<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Lapak UMKM Desa Watuagung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    /* VARIABEL WARNA */
    :root { 
      --emerald: #27ae60; 
      --sun-yellow: #f1c40f;
      --dark-emerald: #1e8449;
      --bg-body: #f8fbf9;
      --bg-card: #ffffff;
      --text-main: #212529;
      --text-muted: #6c757d;
      --border-color: #dee2e6;
      --price-bg: #ffffff;
      --price-text: #27ae60;
    }

    /* DARK MODE VARIABLES */
    [data-bs-theme="dark"] {
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --text-main: #f8f9fa;
      --text-muted: #adb5bd;
      --border-color: #333333;
      --dark-emerald: #0d3d22;
      --price-bg: #2d3436;
      --price-text: #2ecc71;
    }

    body { background: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; transition: 0.3s; overflow-x: hidden; }

    /* Navigasi */
    .navbar { background: var(--emerald) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .navbar-brand img { height: 45px; margin-right: 12px; }

    /* Hero Header */
    .hero-header {
      position: relative; height: 350px;
      background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?auto=format&fit=crop&w=1600&q=80');
      background-size: cover; background-position: center;
      display: flex; align-items: center; justify-content: center; text-align: center; color: white; margin-top: 56px;
    }
    .hero-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(39, 174, 96, 0.7));
    }
    [data-bs-theme="dark"] .hero-overlay { background: linear-gradient(to bottom, rgba(0,0,0,0.5), rgba(0, 0, 0, 0.8)); }

    /* Search Section */
    .search-section { position: relative; margin-top: -50px; z-index: 10; }
    .search-card {
      background: var(--bg-card); border-radius: 15px; padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-bottom: 4px solid var(--sun-yellow);
    }
    .filter-btn {
      border-radius: 50px; padding: 6px 18px; margin: 4px; transition: 0.3s;
      border: 2px solid var(--emerald); color: var(--emerald); background: var(--bg-card); font-weight: 600;
    }
    .filter-btn.active, .filter-btn:hover { background: var(--emerald); color: white; }

    /* UMKM Card */
    .umkm-card { 
        border: 1px solid var(--border-color); 
        border-radius: 15px; 
        background: var(--bg-card); 
        transition: 0.3s; 
        position: relative; 
        overflow: hidden;
        width: 100%; 
    }
    .umkm-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
    .card-img-wrapper { width: 100%; height: 180px; background: #f4f4f4; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .card-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    
    .price-tag { 
        background: var(--price-bg); color: var(--price-text); 
        font-weight: 700; font-size: 0.85rem; 
        position: absolute; top: 12px; right: 12px; 
        padding: 4px 12px; border-radius: 20px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.15); z-index: 5;
    }

    /* Map */
    #map { height: 450px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

    /* Footer */
    footer { background: var(--dark-emerald); color: white; padding: 60px 0 30px; transition: background 0.3s; }
    .footer-logo { height: 80px; width: auto; max-width: 100%; margin-bottom: 20px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); object-fit: contain; }
    .unnes-logo { height: 60px; width: auto; margin-top: 15px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); object-fit: contain; }

    .dark-toggle { cursor: pointer; color: white; font-size: 1.5rem; margin-left: 15px; }

    /* SMART DARK MAP FILTER */
    [data-bs-theme="dark"] .leaflet-layer,
    [data-bs-theme="dark"] .leaflet-control-zoom-in,
    [data-bs-theme="dark"] .leaflet-control-zoom-out,
    [data-bs-theme="dark"] .leaflet-control-locate {
        filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
    }
    [data-bs-theme="dark"] .leaflet-marker-icon,
    [data-bs-theme="dark"] .leaflet-popup-content-wrapper,
    [data-bs-theme="dark"] .leaflet-popup-tip { filter: none !important; }

    @media (max-width: 768px) {
      .hero-content h1 { font-size: 2rem; }
      #map { height: 300px; }
      footer { text-align: center; }
      .col-lg-5, .col-lg-4, .col-lg-3 { display: flex; flex-direction: column; align-items: center; text-align: center !important; }
      .footer-logo { height: 65px; } 
      .unnes-logo { height: 50px; }
      .social-icons { justify-content: center; display: flex; margin-bottom: 20px; }
    }
  </style>
</head>
<body data-bs-theme="light">

<nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold d-flex align-items-center" href="#">
      <img src="https://drive.google.com/thumbnail?id=1QGmzIhjCJvDfIADZ_6RfWXUOStUSK4dg&sz=w200" alt="Logo Kabupaten Semarang">
      WATUAGUNG HUB
    </a>
    <div class="dark-toggle" onclick="toggleDarkMode()" title="Ubah Mode Tampilan">
        <i id="darkModeIcon" class="bi bi-moon-stars-fill"></i>
    </div>
  </div>
</nav>

<header class="hero-header">
  <div class="hero-overlay"></div>
  <div class="hero-content">
    <h1 class="fw-bold">Lapak UMKM Desa Watuagung</h1>
    <p class="lead">Produk UMKM yang berkualitas di Desa Watuagung</p>
  </div>
</header>

<section class="container search-section">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="search-card text-center">
        <div class="input-group mb-3 shadow-sm">
          <span class="input-group-text bg-transparent border-success text-success"><i class="bi bi-search"></i></span>
          <input type="text" id="searchInput" class="form-control bg-transparent border-success py-2 text-main" placeholder="Cari produk unggulan desa...">
        </div>
        <div id="filterContainer" class="d-flex flex-wrap justify-content-center">
          <button class="filter-btn active" onclick="filterData('Semua', this)">Semua Produk</button>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="container my-5">
  <div class="row g-4">
    <div class="col-md-7 order-1">
      <div id="umkmContainer" class="row g-3 justify-content-center">
          <div class="text-center py-5"><div class="spinner-border text-success"></div></div>
      </div>
    </div>
    <div class="col-md-5 order-2">
      <div class="sticky-top" style="top: 80px;">
        <div id="map"></div>
        <div class="mt-2 small text-muted text-center">
            <i class="bi bi-info-circle me-1"></i>Klik ikon target di peta untuk melihat posisi Anda
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-4 overflow-hidden bg-card">
      <div class="modal-header bg-success text-white border-0">
        <h5 class="modal-title fw-bold" id="modalNama">Detail Produk</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <img id="modalFoto" src="" class="img-fluid rounded-4 mb-3 shadow-sm w-100" style="max-height:280px; object-fit: contain; background: #f8f9fa;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span id="modalKategori" class="badge bg-success">Kategori</span>
            <span class="text-success fw-bold h5 mb-0" id="modalHarga"></span>
        </div>
        <p id="modalDeskripsi" class="text-muted"></p>
        <div class="p-3 rounded-3 small border-start border-success border-4" style="background: rgba(var(--emerald), 0.1);">
            <p class="mb-1"><strong><i class="bi bi-clock text-success me-2"></i>Jam Buka:</strong> <span id="modalJam"></span></p>
            <p class="mb-0"><strong><i class="bi bi-geo-alt text-success me-2"></i>Alamat:</strong> <span id="modalAlamat"></span></p>
        </div>
      </div>
      <div class="modal-footer border-0 p-3 flex-column">
        <div class="d-flex gap-2 w-100 mb-2">
            <a id="modalWA" href="#" target="_blank" class="btn btn-success flex-fill py-2 fw-bold rounded-pill shadow-sm">
                <i class="bi bi-whatsapp me-2"></i>Chat
            </a>
            <a id="modalRoute" href="#" target="_blank" class="btn btn-primary flex-fill py-2 fw-bold rounded-pill shadow-sm">
                <i class="bi bi-geo-alt-fill me-2"></i>Rute
            </a>
        </div>
        <button id="btnShare" class="btn btn-outline-primary w-100 py-2 fw-bold rounded-pill">
            <i class="bi bi-share me-2"></i>Bagikan Produk
        </button>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container text-start">
    <div class="row g-4 justify-content-between">
      <div class="col-lg-5">
        <img src="https://drive.google.com/thumbnail?id=1QGmzIhjCJvDfIADZ_6RfWXUOStUSK4dg&sz=w400" alt="Logo Kabupaten" class="footer-logo">
        <h5 class="fw-bold mb-3">Pemerintah Desa Watuagung</h5>
        <p class="small opacity-75">Jl. Raya Watuagung - Salatiga KM 5, Desa Watuagung, Kec. Tuntang, Kab. Semarang, Jawa Tengah</p>
      </div>
      <div class="col-lg-4 text-start">
        <h5 class="fw-bold mb-4">Kontak Kami</h5>
        <div class="contact-item"><i class="bi bi-envelope-at-fill"></i><span>nofitasari.watuagung@desa.mail.go.id</span></div>
        <div class="contact-item"><i class="bi bi-telephone-fill"></i><span>085727234073</span></div>
        <div class="contact-item"><i class="bi bi-globe"></i><a href="https://watuagung-tuntang.web.id/" target="_blank" class="text-white text-decoration-none">watuagung-tuntang.web.id</a></div>
      </div>
      <div class="col-lg-3 text-start">
        <h5 class="fw-bold mb-4">Media Sosial Desa</h5>
        <div class="social-icons mb-4">
            <a href="https://www.facebook.com/Desawatuagung" target="_blank" class="text-white me-3 fs-4"><i class="bi bi-facebook"></i></a>
            <a href="https://www.instagram.com/desa_watuagung/" target="_blank" class="text-white me-3 fs-4"><i class="bi bi-instagram"></i></a>
            <a href="https://www.youtube.com/@pemdeswatuagung" target="_blank" class="text-white fs-4"><i class="bi bi-youtube"></i></a>
        </div>
        <p class="small mb-1 opacity-75">Dikembangkan oleh Fahturomi Anjar Septian</p>
        <img src="https://drive.google.com/thumbnail?id=1kLMTTGJBuGID2XmM557jpR5wdUrheYKC&sz=w400" alt="Logo UNNES" class="unnes-logo">
      </div>
    </div>
    <hr class="mt-5 opacity-25">
    <div class="text-center small opacity-50">© 2026 Pemerintah Desa Watuagung. KKN Teknik Komputer UNNES.</div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const csv_url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8D5ycFjvpuGb4HCpQiU4HBTYrV2Uo0hMaY6YxiuPzMfrwTXiATihujuC_xnZYgmGNlrE6zOIjQrB1/pub?output=csv";
const centerMap = [-7.276052, 110.482270];

/* Inisialisasi Peta - 1 Layer (OpenStreetMap) dengan Filter CSS untuk Dark Mode */
const map = L.map('map').setView(centerMap, 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    attribution: '© OpenStreetMap' 
}).addTo(map);

/* FUNGSI LOKASI SAYA */
const locateControl = L.control({ position: 'topleft' });
locateControl.onAdd = function() {
    const div = L.DomUtil.create('div', 'leaflet-control-locate');
    div.innerHTML = '<i class="bi bi-crosshair"></i>';
    div.title = "Lokasi Saya";
    div.onclick = function() { map.locate({setView: true, maxZoom: 16}); };
    return div;
};
locateControl.addTo(map);

map.on('locationfound', function(e) {
    L.circle(e.latlng, e.accuracy, {color: '#27ae60'}).addTo(map);
    L.marker(e.latlng).addTo(map).bindPopup("Posisi Anda").openPopup();
});

/* FUNGSI TOGGLE DARK MODE */
function toggleDarkMode() {
    const body = document.body;
    const icon = document.getElementById('darkModeIcon');
    const isDark = body.getAttribute('data-bs-theme') === 'dark';

    if (isDark) {
        body.setAttribute('data-bs-theme', 'light');
        icon.className = 'bi bi-moon-stars-fill';
        localStorage.setItem('theme', 'light');
    } else {
        body.setAttribute('data-bs-theme', 'dark');
        icon.className = 'bi bi-sun-fill';
        localStorage.setItem('theme', 'dark');
    }
}

/* Load Theme Preference */
if (localStorage.getItem('theme') === 'dark' || (window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('theme'))) {
    document.body.setAttribute('data-bs-theme', 'dark');
    document.getElementById('darkModeIcon').className = 'bi bi-sun-fill';
}

let allData = [];
let markers = [];

Papa.parse(csv_url, {
  download: true, header: true,
  complete: function(results) {
    allData = results.data.filter(item => item.Nama);
    createFilterButtons(allData);
    renderUI(allData);
  }
});

function createFilterButtons(data) {
  const categories = [...new Set(data.map(item => item.Kategori).filter(c => c))];
  const container = document.getElementById('filterContainer');
  categories.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.innerText = cat;
    btn.onclick = () => filterData(cat, btn);
    container.appendChild(btn);
  });
}

function renderUI(data) {
  const container = document.getElementById('umkmContainer');
  container.className = "row g-3 justify-content-center"; 
  container.innerHTML = "";
  markers.forEach(m => { if(m) map.removeLayer(m); });
  markers = [];

  data.forEach((item, index) => {
    const originalIndex = allData.indexOf(item);
    let fotoUrl = item.Foto_URL;
    if (fotoUrl && fotoUrl.includes('drive.google.com')) {
      const idMatch = fotoUrl.match(/\/d\/(.+?)(\/|$)/);
      if (idMatch) fotoUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=800`;
    }

    /* --- PERBAIKAN PENTING: No_Wa (kecil) sesuai CSV --- */
    const rawWA = item.No_Wa ? item.No_Wa.toString().replace(/[^0-9]/g, '').replace(/^0/, '62') : '';
    /* --- PERBAIKAN RUTE: Menggunakan Link Standar Google Maps --- */
    const mapsLink = `https://www.google.com/maps/dir/?api=1&destination=${item.Latitude},${item.Longitude}`;

    const col = document.createElement('div');
    col.className = "col-lg-6 col-12 mb-2"; 
    
    col.innerHTML = `
      <div class="card umkm-card shadow-sm h-100 mx-auto" id="card-${originalIndex}">
        <span class="price-tag">${item.Harga || ''}</span>
        <div class="card-img-wrapper"><img src="${fotoUrl || 'https://via.placeholder.com/150'}" alt="${item.Nama}"></div>
        <div class="card-body d-flex flex-column">
          <div class="mb-1"><span class="badge bg-success-subtle text-success" style="font-size: 0.7rem">${item.Kategori || 'UMKM'}</span></div>
          <h6 class="fw-bold mb-1">${item.Nama}</h6>
          <p class="text-muted small mb-3 flex-grow-1" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${item.Deskripsi || ''}</p>
          <div class="d-flex gap-1 mt-auto">
            <button onclick="bukaDetail(${originalIndex})" class="btn btn-success btn-sm flex-fill rounded-pill">Detail</button>
            <a href="https://wa.me/${rawWA}" target="_blank" class="btn btn-outline-success btn-sm px-2 rounded-circle"><i class="bi bi-whatsapp"></i></a>
            <a href="${mapsLink}" target="_blank" class="btn btn-outline-primary btn-sm px-2 rounded-circle"><i class="bi bi-geo-alt-fill"></i></a>
          </div>
        </div>
      </div>
    `;
    container.appendChild(col);

    if (item.Latitude && item.Longitude) {
      const marker = L.marker([parseFloat(item.Latitude), parseFloat(item.Longitude)]).addTo(map);
      marker.on('click', () => bukaDetail(originalIndex));
      markers[originalIndex] = marker;
    }
  });
}

function bukaDetail(index) {
    const item = allData[index];
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    document.getElementById('modalNama').innerText = item.Nama;
    document.getElementById('modalKategori').innerText = item.Kategori || 'UMKM';
    document.getElementById('modalDeskripsi').innerText = item.Deskripsi || 'Produk berkualitas dari Desa Watuagung.';
    document.getElementById('modalJam').innerText = item.Jam_Buka || 'Tanya Penjual';
    document.getElementById('modalHarga').innerText = item.Harga || 'Harga Bersaing';
    document.getElementById('modalAlamat').innerText = item.Alamat || 'Desa Watuagung';
    
    // Perbaikan Link Rute di Modal
    const startRoute = `https://www.google.com/maps/dir/?api=1&destination=${item.Latitude},${item.Longitude}`;
    document.getElementById('modalRoute').href = startRoute;

    let fotoUrl = item.Foto_URL;
    if (fotoUrl && fotoUrl.includes('drive.google.com')) {
      const idMatch = fotoUrl.match(/\/d\/(.+?)(\/|$)/);
      if (idMatch) fotoUrl = `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=800`;
    }
    document.getElementById('modalFoto').src = fotoUrl || 'https://via.placeholder.com/400x300';
    
    // --- PERBAIKAN PENTING: No_Wa (kecil) di Modal ---
    const cleanWA = item.No_Wa ? item.No_Wa.toString().replace(/[^0-9]/g, '').replace(/^0/, '62') : '';
    document.getElementById('modalWA').href = `https://wa.me/${cleanWA}`;

    document.getElementById('btnShare').onclick = function() {
        const text = `Cek produk UMKM ini di Desa Watuagung:\n*${item.Nama}*\nhttps://wa.me/${cleanWA}`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
    };
    modal.show();
    map.setView([parseFloat(item.Latitude), parseFloat(item.Longitude)], 17);
}

function filterData(category, btn) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allData.filter(item => (category === 'Semua' || item.Kategori === category) && item.Nama.toLowerCase().includes(keyword));
  renderUI(filtered);
}

document.getElementById('searchInput').addEventListener('input', () => {
  const activeBtn = document.querySelector('.filter-btn.active');
  filterData(activeBtn.innerText === 'Semua Produk' ? 'Semua' : activeBtn.innerText, activeBtn);
});
</script>
</body>
</html>